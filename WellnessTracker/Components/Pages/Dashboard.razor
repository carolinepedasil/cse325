@page "/dashboard"
@rendermode InteractiveServer

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using WellnessTracker.Services
@using WellnessTracker.Models
@inject IHabitEntryService HabitService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Dashboard</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (isLoading)
        {
            <p>Loading dashboard...</p>
        }
        else if (entries.Count == 0)
        {
            <p>You do not have any entries yet. Add some data on the Habits page.</p>
        }
        else
        {
            <h1>Weekly Dashboard</h1>
            <p class="text-muted">Showing the last 7 days of data.</p>

            <section aria-label="Weekly exercise summary" class="mb-4">
                <h2 class="h4">Exercise (minutes)</h2>
                @foreach (var day in weeklyData)
                {
                    var width = day.TotalExercise == 0 ? 1 : Math.Min(day.TotalExercise, 120); // cap width
                    <div class="mb-1">
                        <span class="fw-semibold">@day.Date.ToString("ddd dd"):</span>
                        <span class="ms-1">@day.TotalExercise min</span>
                        <div class="progress mt-1" role="img"
                             aria-label="@($"On {day.Date:MMMM dd}, you exercised {day.TotalExercise} minutes.")">
                            <div class="progress-bar"
                                 style="width:@width%" 
                                 aria-hidden="true">
                            </div>
                        </div>
                    </div>
                }
            </section>

            <section aria-label="Sleep and water averages" class="mb-4">
                <h2 class="h4">Average Sleep and Water</h2>
                <p>Average sleep: <strong>@avgSleep.ToString("0.0") hours</strong></p>
                <p>Average water: <strong>@avgWater.ToString("0.0") liters</strong></p>
            </section>
        }
    </Authorized>
    <NotAuthorized>
        <p>You need to log in to view the dashboard.</p>
        <NavLink href="account/login" class="btn btn-primary">Go to login</NavLink>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isLoading = true;
    private string? userId;
    private List<HabitEntry> entries = new();

    private List<DailySummary> weeklyData = new();
    private double avgSleep;
    private double avgWater;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = auth.User.FindFirstValue(ClaimTypes.NameIdentifier);

        if (userId is null)
        {
            isLoading = false;
            return;
        }

        var today = DateTime.Today;
        var sevenDaysAgo = today.AddDays(-6);

        entries = await HabitService.GetAllAsync(userId, sevenDaysAgo, today);

        weeklyData = entries
            .GroupBy(e => e.Date.Date)
            .Select(g => new DailySummary
            {
                Date = g.Key,
                TotalExercise = g.Sum(x => x.ExerciseMinutes)
            })
            .OrderBy(d => d.Date)
            .ToList();

        if (entries.Count > 0)
        {
            avgSleep = entries.Average(e => e.SleepHours);
            avgWater = entries.Average(e => e.WaterLiters);
        }

        isLoading = false;
    }

    public class DailySummary
    {
        public DateTime Date { get; set; }
        public int TotalExercise { get; set; }
    }
}

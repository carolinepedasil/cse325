@page "/habits"
@rendermode InteractiveServer

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using WellnessTracker.Models
@using WellnessTracker.Services
@inject IHabitEntryService HabitService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Habits</PageTitle>

<AuthorizeView>
    <Authorized Context="authState">
        @if (isLoading)
        {
            <p>Loading your data...</p>
        }
        else
        {
            <h1>Daily Wellness Entries</h1>

            <section aria-label="Filter by date" class="mb-3">
                <div class="row g-2">
                    <div class="col-12 col-md-3">
                        <label for="startDate">Start date</label>
                        <InputDate id="startDate" @bind-Value="startDate" class="form-control" />
                    </div>
                    <div class="col-12 col-md-3">
                        <label for="endDate">End date</label>
                        <InputDate id="endDate" @bind-Value="endDate" class="form-control" />
                    </div>
                    <div class="col-12 col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary me-2" @onclick="ApplyFilter">Apply filter</button>
                        <button class="btn btn-outline-secondary" @onclick="ClearFilter">Clear</button>
                    </div>
                </div>
            </section>

            <section class="card mb-4 p-3" aria-label="Add or edit wellness entry">
            </section>

        }
    </Authorized>
    <NotAuthorized>
        <p>You need to log in to manage your wellness entries.</p>
        <NavLink class="btn btn-primary" href="account/login">Go to login</NavLink>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string? userId;
    private bool isLoading = true;

    private HabitEntryFormModel formModel = new() { Date = DateTime.Today };
    private List<HabitEntry> entries = new();
    private int? editingId;

    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

        if (userId is null)
        {
            isLoading = false;
            return;
        }

        await LoadEntriesAsync();
        isLoading = false;
    }

    private async Task LoadEntriesAsync()
    {
        if (userId is null) return;
        entries = await HabitService.GetAllAsync(userId, startDate, endDate);
    }

    private async Task HandleSave()
    {
        if (userId is null) return;

        if (editingId.HasValue)
        {
            var existing = await HabitService.GetByIdAsync(editingId.Value, userId);
            if (existing is null) return;

            existing.Date = formModel.Date;
            existing.ExerciseMinutes = formModel.ExerciseMinutes;
            existing.SleepHours = formModel.SleepHours;
            existing.WaterLiters = formModel.WaterLiters;
            existing.Mood = formModel.Mood;
            existing.Notes = formModel.Notes;

            await HabitService.UpdateAsync(existing);
        }
        else
        {
            var entry = new HabitEntry
            {
                UserId = userId!,
                Date = formModel.Date,
                ExerciseMinutes = formModel.ExerciseMinutes,
                SleepHours = formModel.SleepHours,
                WaterLiters = formModel.WaterLiters,
                Mood = formModel.Mood,
                Notes = formModel.Notes
            };

            await HabitService.AddAsync(entry);
        }

        await LoadEntriesAsync();
        formModel = new HabitEntryFormModel { Date = DateTime.Today };
        editingId = null;
    }

    private async Task StartEdit(int id)
    {
        if (userId is null) return;
        var entry = await HabitService.GetByIdAsync(id, userId);
        if (entry is null) return;

        editingId = entry.Id;
        formModel = new HabitEntryFormModel
        {
            Date = entry.Date,
            ExerciseMinutes = entry.ExerciseMinutes,
            SleepHours = entry.SleepHours,
            WaterLiters = entry.WaterLiters,
            Mood = entry.Mood,
            Notes = entry.Notes
        };
    }

    private void CancelEdit()
    {
        editingId = null;
        formModel = new HabitEntryFormModel { Date = DateTime.Today };
    }

    private async Task DeleteEntry(int id)
    {
        if (userId is null) return;
        await HabitService.DeleteAsync(id, userId);
        await LoadEntriesAsync();
        if (editingId == id)
        {
            CancelEdit();
        }
    }

    private async Task ApplyFilter()
    {
        await LoadEntriesAsync();
    }

    private async Task ClearFilter()
    {
        startDate = null;
        endDate = null;
        await LoadEntriesAsync();
    }

    public class HabitEntryFormModel
    {
        [Required]
        public DateTime Date { get; set; }

        [Range(0, 600)]
        public int ExerciseMinutes { get; set; }

        [Range(0, 24)]
        public double SleepHours { get; set; }

        [Range(0, 20)]
        public double WaterLiters { get; set; }

        [MaxLength(100)]
        public string Mood { get; set; } = string.Empty;

        [MaxLength(500)]
        public string? Notes { get; set; }
    }
}

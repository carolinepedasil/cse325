@page "/habits"
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using WellnessTracker.Models
@using WellnessTracker.Services
@inject IHabitEntryService HabitService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Habits</PageTitle>

<AuthorizeView>
    <Authorized Context="authState">
        @if (isLoading)
        {
            <p>Loading your data...</p>
        }
        else
        {
            <h1>Daily Wellness Entries</h1>

            <!-- FILTER SECTION -->
            <section aria-label="Filter by date" class="mb-3">
                <div class="row g-2">
                    <div class="col-12 col-md-3">
                        <label for="startDate" class="form-label">Start date</label>
                        <InputDate id="startDate" @bind-Value="startDate" class="form-control" />
                    </div>
                    <div class="col-12 col-md-3">
                        <label for="endDate" class="form-label">End date</label>
                        <InputDate id="endDate" @bind-Value="endDate" class="form-control" />
                    </div>
                    <div class="col-12 col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary me-2" @onclick="ApplyFilter">Apply filter</button>
                        <button class="btn btn-outline-secondary" @onclick="ClearFilter">Clear</button>
                    </div>
                </div>
            </section>

            <!-- ADD / EDIT ENTRY FORM -->
            <section class="card mb-4 p-3" aria-label="Add or edit wellness entry">
                <h2 class="h4">
                    @(editingId.HasValue ? "Edit daily entry" : "Add new daily entry")
                </h2>

                <EditForm Model="@formModel" OnValidSubmit="@HandleSave">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row g-3">
                        <div class="col-12 col-md-3">
                            <label class="form-label" for="entryDate">Date</label>
                            <InputDate id="entryDate" class="form-control" @bind-Value="formModel.Date" />
                        </div>

                        <div class="col-12 col-md-3">
                            <label class="form-label" for="exercise">Exercise (minutes)</label>
                            <InputNumber id="exercise"
                                         class="form-control"
                                         @bind-Value="formModel.ExerciseMinutes" />
                        </div>

                        <div class="col-12 col-md-3">
                            <label class="form-label" for="sleep">Sleep (hours)</label>
                            <InputNumber id="sleep"
                                         class="form-control"
                                         @bind-Value="formModel.SleepHours" />
                        </div>

                        <div class="col-12 col-md-3">
                            <label class="form-label" for="water">Water (liters)</label>
                            <InputNumber id="water"
                                         class="form-control"
                                         @bind-Value="formModel.WaterLiters" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label" for="mood">Mood</label>
                            <InputText id="mood"
                                       class="form-control"
                                       @bind-Value="formModel.Mood" />
                        </div>

                        <div class="col-12">
                            <label class="form-label" for="notes">Notes</label>
                            <InputTextArea id="notes"
                                           class="form-control"
                                           @bind-Value="formModel.Notes" />
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary me-2">
                            @(editingId.HasValue ? "Save changes" : "Save entry")
                        </button>

                        @if (editingId.HasValue)
                        {
                            <button type="button" class="btn btn-secondary me-2" @onclick="CancelEdit">
                                Cancel
                            </button>
                        }
                    </div>
                </EditForm>
            </section>

            <!-- ENTRIES TABLE -->
            <section aria-label="Existing wellness entries">
                <h2 class="h4">Entries</h2>

                @if (entries.Count == 0)
                {
                    <p class="text-muted">No entries found for the selected period.</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Exercise (min)</th>
                                    <th scope="col">Sleep (hrs)</th>
                                    <th scope="col">Water (L)</th>
                                    <th scope="col">Mood</th>
                                    <th scope="col">Notes</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in entries.OrderByDescending(e => e.Date))
                                {
                                    <tr>
                                        <td>@entry.Date.ToString("yyyy-MM-dd")</td>
                                        <td>@entry.ExerciseMinutes</td>
                                        <td>@entry.SleepHours</td>
                                        <td>@entry.WaterLiters</td>
                                        <td>@entry.Mood</td>
                                        <td>@entry.Notes</td>
                                        <td>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-primary me-2"
                                                    @onclick="() => StartEdit(entry.Id)">
                                                Edit
                                            </button>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger"
                                                    @onclick="() => DeleteEntry(entry.Id)">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </section>
        }
    </Authorized>
    <NotAuthorized>
        <p>You need to log in to manage your wellness entries.</p>
        <NavLink class="btn btn-primary" href="account/login">Go to login</NavLink>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string? userId;
    private bool isLoading = true;

    private HabitEntryFormModel formModel = new() { Date = DateTime.Today };
    private List<HabitEntry> entries = new();
    private int? editingId;

    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

        if (userId is null)
        {
            isLoading = false;
            return;
        }

        await LoadEntriesAsync();
        isLoading = false;
    }

    private async Task LoadEntriesAsync()
    {
        if (userId is null) return;
        entries = await HabitService.GetAllAsync(userId, startDate, endDate);
    }

    private async Task HandleSave()
    {
        if (userId is null) return;

        if (editingId.HasValue)
        {
            var existing = await HabitService.GetByIdAsync(editingId.Value, userId);
            if (existing is null) return;

            existing.Date = formModel.Date;
            existing.ExerciseMinutes = formModel.ExerciseMinutes;
            existing.SleepHours = formModel.SleepHours;
            existing.WaterLiters = formModel.WaterLiters;
            existing.Mood = formModel.Mood;
            existing.Notes = formModel.Notes;

            await HabitService.UpdateAsync(existing);
        }
        else
        {
            var entry = new HabitEntry
            {
                UserId = userId!,
                Date = formModel.Date,
                ExerciseMinutes = formModel.ExerciseMinutes,
                SleepHours = formModel.SleepHours,
                WaterLiters = formModel.WaterLiters,
                Mood = formModel.Mood,
                Notes = formModel.Notes
            };

            await HabitService.AddAsync(entry);
        }

        await LoadEntriesAsync();
        formModel = new HabitEntryFormModel { Date = DateTime.Today };
        editingId = null;
    }

    private async Task StartEdit(int id)
    {
        if (userId is null) return;
        var entry = await HabitService.GetByIdAsync(id, userId);
        if (entry is null) return;

        editingId = entry.Id;
        formModel = new HabitEntryFormModel
        {
            Date = entry.Date,
            ExerciseMinutes = entry.ExerciseMinutes,
            SleepHours = entry.SleepHours,
            WaterLiters = entry.WaterLiters,
            Mood = entry.Mood,
            Notes = entry.Notes
        };
    }

    private void CancelEdit()
    {
        editingId = null;
        formModel = new HabitEntryFormModel { Date = DateTime.Today };
    }

    private async Task DeleteEntry(int id)
    {
        if (userId is null) return;
        await HabitService.DeleteAsync(id, userId);
        await LoadEntriesAsync();
        if (editingId == id)
        {
            CancelEdit();
        }
    }

    private async Task ApplyFilter()
    {
        await LoadEntriesAsync();
    }

    private async Task ClearFilter()
    {
        startDate = null;
        endDate = null;
        await LoadEntriesAsync();
    }

    public class HabitEntryFormModel
    {
        [Required]
        public DateTime Date { get; set; }

        [Range(0, 600)]
        public int ExerciseMinutes { get; set; }

        [Range(0, 24)]
        public double SleepHours { get; set; }

        [Range(0, 20)]
        public double WaterLiters { get; set; }

        [MaxLength(100)]
        public string Mood { get; set; } = string.Empty;

        [MaxLength(500)]
        public string? Notes { get; set; }
    }
}

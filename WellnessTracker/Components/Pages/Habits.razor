@page "/habits"
@rendermode InteractiveServer

@using WellnessTracker.Models
@using WellnessTracker.Services
@using System.ComponentModel.DataAnnotations
@using System.Linq
@inject IHabitEntryService HabitService

<PageTitle>Habits</PageTitle>

<h1>Daily Wellness Entries</h1>

<p>Use this page to log your daily exercise, sleep, hydration, and mood.</p>

<div class="card mb-4 p-3">

    <div class="mb-3">
        <label>Date</label><br />
        <InputDate @bind-Value="formModel.Date" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Exercise (minutes)</label><br />
        <InputNumber @bind-Value="formModel.ExerciseMinutes" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Sleep (hours)</label><br />
        <InputNumber @bind-Value="formModel.SleepHours" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Water (liters)</label><br />
        <InputNumber @bind-Value="formModel.WaterLiters" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Mood</label><br />
        <InputText @bind-Value="formModel.Mood" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Notes</label><br />
        <InputTextArea @bind-Value="formModel.Notes" class="form-control" />
    </div>

    <button class="btn btn-primary me-2" @onclick="HandleSave">
        @(editingId.HasValue ? "Save changes" : "Add entry")
    </button>

    @if (editingId.HasValue)
    {
        <button class="btn btn-secondary" @onclick="CancelEdit">
            Cancel
        </button>
    }
</div>

<hr />

<h3>Summary (based on all entries)</h3>

@if (entries.Count == 0)
{
    <p>No entries yet.</p>
}
else
{
    <ul>
        <li>Total entries: @entries.Count</li>
        <li>Total exercise minutes: @entries.Sum(e => e.ExerciseMinutes)</li>
        <li>Average sleep hours: @entries.Average(e => e.SleepHours).ToString("0.0")</li>
        <li>Average water (liters): @entries.Average(e => e.WaterLiters).ToString("0.0")</li>
    </ul>
}

<hr />

<h3>All entries</h3>

@if (entries.Count == 0)
{
    <p>No entries yet. Add your first wellness entry above.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Exercise (min)</th>
                <th>Sleep (hrs)</th>
                <th>Water (L)</th>
                <th>Mood</th>
                <th>Notes</th>
                <th style="width: 160px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in entries)
            {
                <tr>
                    <td>@entry.Date.ToShortDateString()</td>
                    <td>@entry.ExerciseMinutes</td>
                    <td>@entry.SleepHours</td>
                    <td>@entry.WaterLiters</td>
                    <td>@entry.Mood</td>
                    <td>@entry.Notes</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(entry.Id)">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteEntry(entry.Id)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private HabitEntryFormModel formModel = new()
    {
        Date = DateTime.Today
    };

    private List<HabitEntry> entries = new();
    private int? editingId;

    protected override async Task OnInitializedAsync()
    {
        entries = await HabitService.GetAllAsync();
    }

    private async Task HandleSave()
    {
        // Simples "validação manual"
        if (formModel.SleepHours < 0 || formModel.SleepHours > 24)
        {
            return;
        }

        if (editingId.HasValue)
        {
            // update existing
            var updated = new HabitEntry
            {
                Id = editingId.Value,
                Date = formModel.Date,
                ExerciseMinutes = formModel.ExerciseMinutes,
                SleepHours = formModel.SleepHours,
                WaterLiters = formModel.WaterLiters,
                Mood = formModel.Mood,
                Notes = formModel.Notes
            };

            await HabitService.UpdateAsync(updated);
        }
        else
        {
            var entry = new HabitEntry
            {
                Date = formModel.Date,
                ExerciseMinutes = formModel.ExerciseMinutes,
                SleepHours = formModel.SleepHours,
                WaterLiters = formModel.WaterLiters,
                Mood = formModel.Mood,
                Notes = formModel.Notes
            };

            await HabitService.AddAsync(entry);
        }

        entries = await HabitService.GetAllAsync();

        formModel = new HabitEntryFormModel
        {
            Date = DateTime.Today
        };
        editingId = null;
    }

    private async Task StartEdit(int id)
    {
        var entry = await HabitService.GetByIdAsync(id);
        if (entry is null) return;

        editingId = entry.Id;
        formModel = new HabitEntryFormModel
        {
            Date = entry.Date,
            ExerciseMinutes = entry.ExerciseMinutes,
            SleepHours = entry.SleepHours,
            WaterLiters = entry.WaterLiters,
            Mood = entry.Mood,
            Notes = entry.Notes
        };
    }

    private void CancelEdit()
    {
        editingId = null;
        formModel = new HabitEntryFormModel
        {
            Date = DateTime.Today
        };
    }

    private async Task DeleteEntry(int id)
    {
        await HabitService.DeleteAsync(id);
        entries = await HabitService.GetAllAsync();

        if (editingId == id)
        {
            CancelEdit();
        }
    }

    public class HabitEntryFormModel
    {
        [Required]
        public DateTime Date { get; set; }

        [Range(0, 600)]
        public int ExerciseMinutes { get; set; }

        [Range(0, 24)]
        public double SleepHours { get; set; }

        [Range(0, 20)]
        public double WaterLiters { get; set; }

        [MaxLength(100)]
        public string Mood { get; set; } = string.Empty;

        [MaxLength(500)]
        public string? Notes { get; set; }
    }
}
